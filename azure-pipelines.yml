pool:
  vmImage: 'ubuntu-latest'

variables:
  azureServiceConnection: 'Visual Studio Enterprise with MSDN(345d42b9-5ca1-4189-a6d8-a8c32fe22d98)'
  subscriptionId: '345d42b9-5ca1-4189-a6d8-a8c32fe22d98'
  resourceGroupName: 'deploymentTest'
  resourceGroupLocation: 'UKSouth'
  location: 'UKSouth'
  appServicePlanName: 'myAppServicePlan111'
  functionApp1Name: 'testFunctionApp1-xyz123'
  functionApp2Name: 'testFunctionApp2-xyz123'
  serviceBusNamespaceName: 'testServiceBusNamespace-xyz123'
  appInsightsName: 'myAppInsights'
  keyVaultName: 'testKeyVault-xyz1233'
  storageAccountName: 'mystorageaccountjj3424'
  aksClusterName: 'myAKSCluster'
  grafanaNamespace: 'grafana'
  redisNamespace: 'redis'

stages:
  - stage: GenerateSSHKey
    displayName: 'Generate SSH Key'
    jobs:
      - job: GenerateKey
        steps:
          - task: Bash@3
            displayName: 'Generate SSH Key Pair'
            inputs:
              targetType: 'inline'
              script: |
                # Generate SSH key pair without passphrase
                ssh-keygen -t rsa -b 4096 -f id_rsa -N "" -C "azure-pipeline"
                
                # Read the public key
                publicKey=$(cat id_rsa.pub)
                
                # Set the public key as an output variable
                echo "##vso[task.setvariable variable=sshPublicKey;isOutput=true]$publicKey"

          - script: |
              echo "Generated SSH Public Key: $(sshPublicKey)"
            displayName: 'Compare SSH Public Keys'

  - stage: ResourceGroupSetup
    displayName: 'Setup Resource Group'
    dependsOn: GenerateSSHKey
    jobs:
      - job: CreateResourceGroup
        steps:
          - task: AzureCLI@2
            displayName: 'Create Resource Group'
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Create the resource group using Bicep
                az deployment sub create --location $(resourceGroupLocation) --template-file group.bicep --parameters resourceGroupName=$(resourceGroupName) resourceGroupLocation=$(resourceGroupLocation)

  - stage: WhatIfDeployment
    displayName: 'What-If Deployment'
    dependsOn: ResourceGroupSetup
    jobs:
      - job: WhatIf
        variables:
          sshPublicKey: $[ dependencies.GenerateSSHKey.outputs['GenerateKey.sshPublicKey'] ]
        steps:
          - task: AzureCLI@2
            displayName: 'What-If Bicep Template'
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Perform a what-if operation to preview changes
                az deployment group what-if --resource-group $(resourceGroupName) --template-file main.bicep --parameters sshPublicKey="ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDtDArALqxVy909h+qPBMyFHFOe4/KsBb5bU5FAMRy9TSSx7ACrnFrSStOZwKsEdwMKXbufBtf6mv4wAL6i/79ebs3bn8nLUBQU3rAtM/Hh7faG0gyLaGurkSUeaQsn7mu1Gm6QL3oXassyrKJk1aJQFsdvWYpVO1E8Q0dDiehdAZwDDe9dKsDNiXMTMZhit2QiCp2mROaFodI9CUBdqm9nXXSqueMSD2E9XytJAfMzVy6dOashB8BTLRgf1llIwl/qXVzOD4U0NlgGRzMzDgtiNU4EzHw0gYAv3qQRzW0tl5+0PhmVYCGRH6mvOJ/6GgxZT1igJniIpX+epuZufrJvKwv3eO6DKs5FTxR6AbWxXNiyEJ9qfFbNSeM3WFEKoymfbSKDqxiPuPwkUFVQpaxjF2uFEBiTldVCei0QDVH4dnelAeqAXb/twghPdN99nQLyWvpgs0Bp7CSh90qSfo3GRAJwPROdkQGW8TCsVpa0sxWGBh1LS8bpUnlNRy5/78MwtmxFopxf6elIRuiP44LI65shfEcKirFHNvDP6JR/R9trVKvF+pxnbt3uyeJkR8ifPGen8CwK+ZL+b6roqcLEpUiFk+2QH2qsbUyCeGD7y8FTw3QVS0xK7YbP9ZBSKWM1tmtrwiiJf+phQvDzw4NFndwHFdkps65LN9/xV9d7KQ== danehague1@googlemail.com"

  - stage: Approval
    displayName: 'Approval'
    dependsOn: WhatIfDeployment
    jobs:
      - job: ManualApproval
        pool: server
        steps:
          - task: ManualValidation@0
            inputs:
              notifyUsers: |
                danehague1@googlemail.com
              instructions: 'Please validate the build configuration and resume'
              onTimeout: 'resume'
            timeoutInMinutes: 30

  - stage: DeployResources
    displayName: 'Deploy Resources'
    dependsOn: Approval
    jobs:
      - job: Deploy
        variables:
          sshPublicKey: $[ dependencies.GenerateSSHKey.outputs['GenerateKey.sshPublicKey'] ]
        steps:
          - task: AzureCLI@2
            displayName: 'Deploy Bicep Template'
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Deploy the Bicep template with the generated SSH public key
                az deployment group create --resource-group $(resourceGroupName) --template-file main.bicep --parameters sshPublicKey="$(sshPublicKey)"

  - stage: ConfigureKubernetes
    displayName: 'Configure Kubernetes'
    dependsOn: DeployResources
    jobs:
      - job: Configure
        steps:
          - task: HelmInstaller@1
            displayName: 'Install Helm'
            inputs:
              helmVersion: 'latest'

          - task: AzureCLI@2
            displayName: 'Configure kubectl'
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Get AKS credentials
                az aks get-credentials --resource-group $(resourceGroupName) --name $(aksClusterName) --overwrite-existing

          - task: AzureCLI@2
            displayName: 'Create Namespace for Grafana'
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Create namespace for Grafana
                kubectl create namespace $(grafanaNamespace) || true
                kubectl create namespace $(redisNamespace) || true

          - task: AzureCLI@2
            displayName: 'Add Helm Repositories'
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Add Helm repositories
                helm repo add grafana https://grafana.github.io/helm-charts
                helm repo update

          - task: AzureCLI@2
            displayName: 'Install Grafana'
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Install Grafana using Helm
                helm install grafana grafana/grafana --namespace $(grafanaNamespace) --set adminPassword=admin --set service.type=LoadBalancer --set service.port=3000

          - task: AzureCLI@2
            displayName: 'Output Grafana Admin Password'
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Output Grafana admin password
                echo "Grafana Admin Password: admin"

          - task: AzureCLI@2
            displayName: 'Output Grafana and Redis Passwords'
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Grafana Admin Password: admin"
